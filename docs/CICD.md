# CI/CD Pipeline Documentation

## Overview

ChainQuery AI uses **GitHub Actions** for continuous integration and continuous deployment (CI/CD). The pipeline automatically tests, builds, and validates every code change before deployment to Render.

## Workflows

### 1. CI/CD Pipeline (`.github/workflows/ci-cd.yml`)

Runs on every push to `main`/`develop` branches and all pull requests.

#### Backend Tests
- **PostgreSQL Database**: Spins up a Postgres 15 instance
- **Database Migrations**: Runs Alembic migrations
- **Unit Tests**: Executes pytest with coverage reporting
- **Coverage**: Uploads coverage reports to Codecov

#### Frontend Tests
- **TypeScript Checking**: Validates type safety (`tsc --noEmit`)
- **Linting**: Runs ESLint for code quality
- **Unit Tests**: Executes Vitest tests
- **Build Verification**: Ensures production build succeeds

#### Docker Build
- **Multi-stage Build**: Verifies Dockerfile builds successfully
- **Caching**: Uses GitHub Actions cache for faster builds
- **Tag**: Tags with commit SHA for traceability

### 2. Deployment Workflow (`.github/workflows/deploy.yml`)

Runs after CI/CD pipeline completes on `main` branch.

- **Success Path**: Notifies that Render will auto-deploy
- **Failure Path**: Blocks deployment and exits with error

## Environment Variables

### GitHub Secrets (Optional)

Set these in **GitHub Repository Settings → Secrets and variables → Actions**:

```
OPENAI_API_KEY      # Your OpenAI API key (optional, falls back to test-key)
GROQ_API_KEY        # Your Groq API key (optional, falls back to test-key)
```

> **Note**: API keys are optional. The CI pipeline will use dummy keys for testing if secrets aren't set.

### Render Environment Variables

Ensure these are set in **Render Dashboard → Environment**:

```
DATABASE_URL        # Auto-generated by Render Postgres
SECRET_KEY         # JWT secret key
GROQ_API_KEY       # Your Groq API key
```

## Badges

Add these badges to your README:

```markdown
[![CI/CD](https://github.com/Gbolahan43/chainquery-ai/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/Gbolahan43/chainquery-ai/actions/workflows/ci-cd.yml)
[![Deploy](https://github.com/Gbolahan43/chainquery-ai/actions/workflows/deploy.yml/badge.svg)](https://github.com/Gbolahan43/chainquery-ai/actions/workflows/deploy.yml)
```

## Running Tests Locally

### Backend
```bash
cd backend

# Install test dependencies
pip install -r requirements-test.txt

# Run tests with coverage
pytest -v --cov=app --cov-report=term-missing
```

### Frontend
```bash
cd frontend

# Run type checking
npm run type-check

# Run linter
npm run lint

# Run tests
npm run test

# Run tests in watch mode
npm run test:watch
```

## Deployment Flow

1. **Push to `main`** → Triggers CI/CD pipeline
2. **CI/CD passes** → Triggers deployment workflow
3. **Render detects push** → Auto-deploys from GitHub
4. **Build completes** → New version live at https://chainquery-app.onrender.com

## Troubleshooting

### CI Fails on Backend Tests

**Issue**: Postgres connection fails
```bash
FATAL:  password authentication failed for user "postgres"
```

**Solution**: Check that the `services.postgres` configuration in `ci-cd.yml` matches the environment variables.

---

### CI Fails on Frontend Build

**Issue**: TypeScript errors
```bash
error TS2304: Cannot find name 'X'
```

**Solution**: Run `npm run type-check` locally to identify and fix type errors before pushing.

---

### Docker Build Fails

**Issue**: Missing files in build context
```bash
COPY failed: file not found
```

**Solution**: Check `.dockerignore` and ensure necessary files aren't excluded.

---

### Deployment Blocked

**Issue**: CI passed but deployment doesn't trigger

**Solution**: 
1. Check Render webhook configuration
2. Verify branch is set to `main` in Render dashboard
3. Manually trigger deployment from Render

## Best Practices

### Branch Protection

Enable branch protection for `main`:
1. Go to **GitHub → Settings → Branches**
2. Add rule for `main`
3. Enable:
   - ✅ Require pull request reviews
   - ✅ Require status checks to pass (select CI/CD jobs)
   - ✅ Require branches to be up to date

### Pull Request Workflow

1. Create feature branch: `git checkout -b feature/amazing-feature`
2. Make changes and commit
3. Push branch: `git push origin feature/amazing-feature`
4. Open Pull Request on GitHub
5. Wait for CI checks to pass
6. Request review (if team member exists)
7. Merge to `main` after approval

### Commit Messages

Follow conventional commits:
```
feat: Add user profile page
fix: Resolve login token expiration
docs: Update API documentation
test: Add integration tests for auth
ci: Update Node.js version in workflow
```

## Monitoring

### GitHub Actions
- View workflow runs: https://github.com/Gbolahan43/chainquery-ai/actions
- Check test results and logs
- Monitor build times

### Render Dashboard
- Deployment logs: https://dashboard.render.com
- Service health checks
- Error logs and metrics

## Next Steps

- [ ] Add end-to-end (E2E) tests with Playwright
- [ ] Set up staging environment
- [ ] Implement automated security scanning
- [ ] Add performance benchmarking
- [ ] Configure automatic rollback on failures

---

**Questions?** Open an issue or discussion on GitHub!
